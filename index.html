# app.py
from flask import Flask, render_template, request, jsonify
import json
from datetime import datetime

app = Flask(__name__)

# 颜色主题配置（主色+子色）
COLOR_SCHEMES = {
    'blue': ('#3B82F6', '#60A5FA'),
    'green': ('#10B981', '#34D399'),
    'purple': ('#8B5CF6', '#A78BFA'),
    'orange': ('#F97316', '#FB923C'),
    'red': ('#EF4444', '#F87171')
}

# 模拟数据存储（实际应用建议使用数据库）
tasks = []

@app.route('/')
def index():
    return render_template('index.html', color_schemes=COLOR_SCHEMES)

@app.route('/api/tasks', methods=['GET', 'POST'])
def manage_tasks():
    global tasks
    
    if request.method == 'POST':
        data = request.json
        
        if data.get('action') == 'add_main_task':
            # 自动分配颜色主题
            theme = get_next_theme()
            new_task = {
                'id': datetime.now().isoformat(),
                'name': data.get('name', '新主任务'),
                'theme': theme,
                'subtasks': [],
                'progress': 0,
                'unit': '单位'
            }
            tasks.append(new_task)
            
        elif data.get('action') == 'add_subtask':
            # 查找主任务并添加子任务
            main_task = next((t for t in tasks if t['id'] == data['main_id']), None)
            if main_task:
                new_subtask = {
                    'id': datetime.now().isoformat(),
                    'name': data.get('subname', '新子任务'),
                    'current': 0,
                    'total': 1,
                    'unit': data.get('unit', '单位'),
                    'theme': main_task['theme']  # 继承主任务主题
                }
                main_task['subtasks'].append(new_subtask)
                update_progress(main_task)
                
        elif data.get('action') == 'update_task':
            # 更新任务状态
            main_task = next((t for t in tasks if t['id'] == data['main_id']), None)
            subtask = next((s for s in main_task['subtasks'] if s['id'] == data['subid']), None)
            if subtask:
                subtask['current'] = max(0, min(int(data['current']), subtask['total']))
                subtask['total'] = max(1, int(data['total']))
                subtask['unit'] = data['unit']
                subtask['name'] = data['subname']
                update_progress(main_task)
                
        elif data.get('action') == 'delete_task':
            # 删除任务
            global tasks
            tasks = [t for t in tasks if t['id'] != data['id']]
            # 级联删除子任务
            tasks = [{**t, 'subtasks': [s for s in t['subtasks'] if s['id'] != data['id']]} for t in tasks]
            
        save_data()
        return jsonify(success=True)
    
    return jsonify(tasks=tasks)

def update_progress(main_task):
    """更新主任务进度"""
    subtasks = main_task['subtasks']
    total_current = sum(s['current'] for s in subtasks)
    total_total = sum(s['total'] for s in subtasks)
    
    main_task['progress'] = int((total_current / total_total) * 100) if total_total != 0 else 0
    main_task['unit'] = get_common_unit(subtasks)

def get_common_unit(subtasks):
    """获取公共单位"""
    units = [s['unit'] for s in subtasks if s['unit']]
    return max(set(units), key=units.count) if units else '单位'

def get_next_theme():
    """循环获取颜色主题"""
    global tasks
    used_themes = [t['theme'] for t in tasks]
    for theme in COLOR_SCHEMES:
        if theme not in used_themes:
            return theme
    # 循环使用已存在主题
    return list(COLOR_SCHEMES.keys())[len(tasks) % len(COLOR_SCHEMES)]

def save_data():
    """保存数据到文件（实际应用建议使用数据库）"""
    with open('tasks.json', 'w') as f:
        json.dump(tasks, f, indent=2)

def load_data():
    """从文件加载数据"""
    global tasks
    try:
        with open('tasks.json', 'r') as f:
            tasks = json.load(f)
    except FileNotFoundError:
        tasks = []

if __name__ == '__main__':
    load_data()
    app.run(debug=True)
