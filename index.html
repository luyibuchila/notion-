<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多任务进度跟踪器</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .theme-blue .task-border { border-left-color: #3B82F6; }
        .theme-green .task-border { border-left-color: #10B981; }
        .theme-purple .task-border { border-left-color: #8B5CF6; }
        .theme-orange .task-border { border-left-color: #F97316; }
        .theme-red .task-border { border-left-color: #EF4444; }
        
        .sub-theme-blue .progress-bar { background-color: #60A5FA; }
        .sub-theme-green .progress-bar { background-color: #34D399; }
        .sub-theme-purple .progress-bar { background-color: #A78BFA; }
        .sub-theme-orange .progress-bar { background-color: #FB923C; }
        .sub-theme-red .progress-bar { background-color: #F87171; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">多任务进度管理系统</h1>
        
        <div id="task-list" class="space-y-6">
            <!-- 主任务将动态插入此处 -->
        </div>

        <button id="add-main-task" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-4 block mx-auto">
            添加新主任务
        </button>
    </div>

    <script>
        const COLOR_SCHEMES = {{ color_schemes|tojson }};
        let tasks = [];

        // 初始化加载任务
        loadTasks();

        // 添加主任务
        document.getElementById('add-main-task').addEventListener('click', async () => {
            const name = prompt('请输入主任务名称', '新主任务');
            if (name) {
                await fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'add_main_task', name })
                });
                renderTasks();
            }
        });

        // 渲染任务列表
        function renderTasks() {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';
            
            tasks.forEach(mainTask => {
                const mainDiv = document.createElement('div');
                mainDiv.className = `bg-white rounded-lg shadow-md p-4 theme-${mainTask.theme}`;
                
                // 主任务头部
                mainDiv.innerHTML += `
                    <div class="flex justify-between items-center mb-4 task-border">
                        <div class="flex items-center">
                            <input type="text" value="${mainTask.name}" 
                                class="text-xl font-semibold border-none pl-2" 
                                onchange="updateTaskName('${mainTask.id}', this)">
                        </div>
                        
                        <div class="flex items-center">
                            <div class="mr-4">
                                <span class="text-lg font-medium">进度：${mainTask.progress}%</span>
                                <br><span class="text-sm text-gray-500">(${mainTask.current}/${mainTask.total} ${mainTask.unit})</span>
                            </div>
                            
                            <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded ml-4"
                                onclick="deleteTask('${mainTask.id}')">
                                删除
                            </button>
                            
                            <button class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-2 rounded ml-2"
                                onclick="addSubtask('${mainTask.id}', '${mainTask.theme}')">
                                添加子任务
                            </button>
                        </div>
                    </div>
                    
                    <div class="h-2 bg-gray-200 rounded-lg mb-4">
                        <div class="progress-bar h-full bg-${COLOR_SCHEMES[mainTask.theme][0]} 
                            transition-all" style="width: ${mainTask.progress}%"></div>
                    </div>
                    
                    <div class="subtask-list" data-main-id="${mainTask.id}">
                        ${mainTask.subtasks.map(subtask => renderSubtask(subtask, mainTask.theme)).join('')}
                    </div>
                `;
                
                taskList.appendChild(mainDiv);
            });
        }

        // 渲染子任务
        function renderSubtask(subtask, theme) {
            return `
                <div class="flex justify-between items-center bg-gray-50 rounded-lg p-3 mb-2 task-border">
                    <div class="flex items-center">
                        <input type="text" value="${subtask.name}" 
                            class="text-sm pl-2 border-none" 
                            onchange="updateSubtaskName('${subtask.main_id}', '${subtask.id}', this)">
                        
                        <div class="ml-4">
                            <input type="number" value="${subtask.current}" min="0" 
                                class="w-12 text-center border rounded" 
                                onchange="updateSubtaskProgress('${subtask.main_id}', '${subtask.id}', 'current', this)">
                            
                            <span class="mx-1">/</span>
                            
                            <input type="number" value="${subtask.total}" min="1" 
                                class="w-12 text-center border rounded" 
                                onchange="updateSubtaskProgress('${subtask.main_id}', '${subtask.id}', 'total', this)">
                            
                            <input type="text" value="${subtask.unit}" 
                                class="w-16 pl-2 border-none" 
                                onchange="updateSubtaskUnit('${subtask.main_id}', '${subtask.id}', this)">
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <div class="h-2 w-40 bg-gray-200 rounded-lg">
                            <div class="progress-bar h-full bg-${COLOR_SCHEMES[theme][1]}" 
                                style="width: ${(subtask.current / subtask.total * 100).toFixed(1)}%"></div>
                        </div>
                        
                        <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded ml-4"
                            onclick="deleteSubtask('${subtask.main_id}', '${subtask.id}')">
                            删除
                        </button>
                    </div>
                </div>
            `;
        }

        // 数据交互函数
        async function loadTasks() {
            const response = await fetch('/api/tasks');
            tasks = await response.json();
            renderTasks();
        }

        async function updateTaskName(mainId, element) {
            await fetch('/api/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'update_task', 
                    main_id: mainId, 
                    name: element.value 
                })
            });
        }

        async function addSubtask(mainId, theme) {
            const name = prompt('请输入子任务名称', '新子任务');
            if (name) {
                await fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'add_subtask', 
                        main_id: mainId, 
                        subname: name,
                        theme: theme
                    })
                });
                renderTasks();
            }
        }

        async function updateSubtaskProgress(mainId, subId, field, element) {
            await fetch('/api/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'update_task', 
                    main_id: mainId, 
                    subid: subId, 
                    [field]: element.value 
                })
            });
        }

        async function updateSubtaskUnit(mainId, subId, element) {
            await fetch('/api/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'update_task', 
                    main_id: mainId, 
                    subid: subId, 
                    unit: element.value 
                })
            });
        }

        async function deleteTask(taskId) {
            await fetch('/api/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'delete_task', id: taskId })
            });
            renderTasks();
        }

        async function deleteSubtask(mainId, subId) {
            await fetch('/api/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'delete_task', id: subId })
            });
            renderTasks();
        }
    </script>
</body>
</html>
